<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drag and Drop Blocks with Grid</title>
    <style>
        /* ... Your existing CSS ... */
    </style>
</head>
<body>

    <div id="gridContainer">
        <!-- Grid Cells -->
        <!-- 100 grid cells (10x10 grid) -->
        <!-- ... Your existing grid cells ... -->
    </div>

    <div id="blockContainer">
        <div id="greenBlock" class="dragBlock"></div>
        <div id="redBlock" class="dragBlock"></div>
        <div id="blueBlock" class="dragBlock"></div>
    </div>

    <script>
        let blocksOnGrid = 0; // Counter for blocks placed on the grid
        const gridSize = 40; // Grid cell size
        const blockContainer = document.getElementById('blockContainer');

        // Function to initialize blocks in the bottom row
        function initializeBlocks() {
            const blockWidth = 40;
            const spacing = 5;
            const startX = (window.innerWidth - (blockWidth * 3 + spacing * 2)) / 2;

            const blocks = document.querySelectorAll('.dragBlock');
            blocks.forEach((block, index) => {
                block.style.left = `${startX + index * (blockWidth + spacing)}px`;
                block.style.top = `${window.innerHeight - blockWidth}px`;
                block.style.transition = 'top 0.2s, left 0.2s';
            });
        }

        // Function to handle drag behavior
        function handleDrag(block, blockIndex) {
            let isDragging = false;
            let offsetX = 0;
            let offsetY = 0;

            block.addEventListener('touchstart', (e) => {
                isDragging = true;
                const touch = e.touches[0];
                offsetX = touch.clientX - block.getBoundingClientRect().left;
                offsetY = touch.clientY - block.getBoundingClientRect().top;
                block.style.transition = 'none';
                e.preventDefault();
            });

            block.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    const touch = e.touches[0];
                    block.style.left = `${touch.clientX - offsetX}px`;
                    block.style.top = `${touch.clientY - offsetY}px`;
                    e.preventDefault();
                }
            });

            block.addEventListener('touchend', () => {
                isDragging = false;
                const blockRect = block.getBoundingClientRect();
                let droppedInCell = false;

                document.querySelectorAll('.gridCell').forEach(cell => {
                    const cellRect = cell.getBoundingClientRect();
                    if (
                        Math.abs(blockRect.left + blockRect.width / 2 - (cellRect.left + cellRect.width / 2)) < gridSize / 2 &&
                        Math.abs(blockRect.top + blockRect.height / 2 - (cellRect.top + cellRect.height / 2)) < gridSize / 2
                    ) {
                        block.style.left = `${cellRect.left}px`;
                        block.style.top = `${cellRect.top}px`;
                        droppedInCell = true;
                        blocksOnGrid++;
                    }
                });

                if (!droppedInCell) {
                    const startX = (window.innerWidth - (40 * 3 + 10 * 2)) / 2 + (blockIndex * (40 + 10));
                    block.style.left = `${startX}px`;
                    block.style.top = `${window.innerHeight - 40}px`;
                }

                block.style.transition = 'top 0.2s, left 0.2s';

                if (blocksOnGrid === 3) {
                    spawnNewBlocks();
                }
            });
        }

        // Function to spawn new blocks
        function spawnNewBlocks() {
            blockContainer.innerHTML = ''; // Clear existing blocks from the container
            const colors = ['#4CAF50', '#FF0000', '#0000FF'];

            colors.forEach((color, index) => {
                const newBlock = document.createElement('div');
                newBlock.classList.add('dragBlock');
                newBlock.style.backgroundColor = color;
                blockContainer.appendChild(newBlock);
                handleDrag(newBlock, index);
            });

            blocksOnGrid = 0; // Reset counter
            initializeBlocks(); // Reinitialize positions
        }

        // Initialize blocks and drag behavior
        document.querySelectorAll('.dragBlock').forEach((block, index) => handleDrag(block, index));
        initializeBlocks();
    </script>
</body>
</html>
